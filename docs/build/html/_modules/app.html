

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>app &mdash; HOPE-Segmenter-Kids 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=f2a433a1"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            HOPE-Segmenter-Kids
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../app.html">app</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">HOPE-Segmenter-Kids</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">app</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for app</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">SimpleITK</span> <span class="k">as</span> <span class="nn">sitk</span>
<span class="kn">import</span> <span class="nn">PIL</span>
<span class="kn">import</span> <span class="nn">gradio</span> <span class="k">as</span> <span class="nn">gr</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">app_assets</span> <span class="kn">import</span> <span class="n">logo</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>

<span class="c1"># Configure the logger for the module</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>

<span class="c1"># Constants</span>

<span class="c1"># Always use a dummy name to maintain anonymity</span>
<span class="n">DUMMY_DIR</span> <span class="o">=</span> <span class="s2">&quot;BraTS-PED-00019-000&quot;</span>
<span class="n">DUMMY_FILE_NAMES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">modality</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DUMMY_DIR</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">modality</span><span class="si">}</span><span class="s2">.nii.gz&quot;</span>
    <span class="k">for</span> <span class="n">modality</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;t1c&quot;</span><span class="p">,</span> <span class="s2">&quot;t2f&quot;</span><span class="p">,</span> <span class="s2">&quot;t1n&quot;</span><span class="p">,</span> <span class="s2">&quot;t2w&quot;</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Docker image for inference</span>
<span class="n">docker</span> <span class="o">=</span> <span class="s2">&quot;aparida12/brats-peds-2024:v20240913&quot;</span>

<span class="c1"># Dictionary to store intermediate results and paths</span>
<span class="n">mydict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>


<div class="viewcode-block" id="run_inference">
<a class="viewcode-back" href="../app.html#app.run_inference">[docs]</a>
<span class="k">def</span> <span class="nf">run_inference</span><span class="p">(</span>
    <span class="n">image_t1c</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">image_t2f</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">image_t1n</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">image_t2w</span><span class="p">:</span> <span class="n">Path</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run inference on the provided MRI image paths.</span>

<span class="sd">    This function performs the following steps:</span>
<span class="sd">    1. Copies the provided MRI images to a temporary input directory.</span>
<span class="sd">    2. Removes the original uploaded files.</span>
<span class="sd">    3. Executes a Docker container to perform segmentation inference.</span>
<span class="sd">    4. Moves the inference output to the designated output directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        image_t1c (Path): Path to the T1 contrast-enhanced MRI image.</span>
<span class="sd">        image_t2f (Path): Path to the T2 FLAIR MRI image.</span>
<span class="sd">        image_t1n (Path): Path to the T1 pre-contrast MRI image.</span>
<span class="sd">        image_t2w (Path): Path to the T2 weighted MRI image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[str, str]: </span>
<span class="sd">            - Path to the input directory containing copied images.</span>
<span class="sd">            - Path to the output segmentation file.</span>

<span class="sd">    Raises:</span>
<span class="sd">        subprocess.CalledProcessError: If any subprocess command fails during execution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Aggregate image paths into a dictionary</span>
    <span class="n">image_paths</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;t1c&quot;</span><span class="p">:</span> <span class="n">image_t1c</span><span class="p">,</span>
        <span class="s2">&quot;t2f&quot;</span><span class="p">:</span> <span class="n">image_t2f</span><span class="p">,</span>
        <span class="s2">&quot;t1n&quot;</span><span class="p">:</span> <span class="n">image_t1n</span><span class="p">,</span>
        <span class="s2">&quot;t2w&quot;</span><span class="p">:</span> <span class="n">image_t2w</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Define and create the input directory</span>
    <span class="n">input_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/tmp/peds-app&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">DUMMY_DIR</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Define and create the output directory</span>
    <span class="n">output_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./segmenter/mlcube/outs&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Define paths for the output segmentation</span>
    <span class="n">output_path</span> <span class="o">=</span> <span class="n">output_folder</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;seg_</span><span class="si">{</span><span class="n">image_t1c</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">fake_output_path</span> <span class="o">=</span> <span class="n">output_folder</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DUMMY_DIR</span><span class="si">}</span><span class="s2">.nii.gz&quot;</span>

    <span class="c1"># Copy each image to the input directory with the dummy filenames</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">image_paths</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;cp </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">input_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">DUMMY_FILE_NAMES</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Remove the original uploaded files to free up space</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">image_paths</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Construct the Docker command for inference</span>
    <span class="n">mlcube_cmd</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;docker run --shm-size=2gb --gpus=all &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;-v </span><span class="si">{</span><span class="n">input_path</span><span class="o">.</span><span class="n">parent</span><span class="si">}</span><span class="s2">:/input/ -v </span><span class="si">{</span><span class="n">output_folder</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span><span class="si">}</span><span class="s2">:/output &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">docker</span><span class="si">}</span><span class="s2"> infer --data_path /input/ --output_path /output/&quot;</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">mlcube_cmd</span><span class="p">)</span>

    <span class="c1"># Execute the Docker command</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">mlcube_cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Move the fake output to the actual output path</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;mv -f </span><span class="si">{</span><span class="n">fake_output_path</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">input_path</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_img_mask">
<a class="viewcode-back" href="../app.html#app.get_img_mask">[docs]</a>
<span class="k">def</span> <span class="nf">get_img_mask</span><span class="p">(</span>
    <span class="n">image_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mask_path</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sitk</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve and normalize image and mask data from file paths.</span>

<span class="sd">    This function reads the MRI image and corresponding mask from the provided file paths,</span>
<span class="sd">    converts them to NumPy arrays, and normalizes the image data.</span>

<span class="sd">    Args:</span>
<span class="sd">        image_path (str): Path to the MRI image file.</span>
<span class="sd">        mask_path (str): Path to the segmentation mask file.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[np.ndarray, sitk.Image, np.ndarray]: </span>
<span class="sd">            - Normalized image array.</span>
<span class="sd">            - SimpleITK image object for the MRI image.</span>
<span class="sd">            - Mask array.</span>

<span class="sd">    Raises:</span>
<span class="sd">        Exception: If there is an error reading the image or mask files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Read the MRI image and mask using SimpleITK</span>
        <span class="n">img_obj</span> <span class="o">=</span> <span class="n">sitk</span><span class="o">.</span><span class="n">ReadImage</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
        <span class="n">mask_obj</span> <span class="o">=</span> <span class="n">sitk</span><span class="o">.</span><span class="n">ReadImage</span><span class="p">(</span><span class="n">mask_path</span><span class="p">)</span>

        <span class="c1"># Convert the images to NumPy arrays for processing</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">sitk</span><span class="o">.</span><span class="n">GetArrayFromImage</span><span class="p">(</span><span class="n">img_obj</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">sitk</span><span class="o">.</span><span class="n">GetArrayFromImage</span><span class="p">(</span><span class="n">mask_obj</span><span class="p">)</span>

        <span class="c1"># Normalize the image data to range [0, 255]</span>
        <span class="n">minval</span><span class="p">,</span> <span class="n">maxval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="p">((</span><span class="n">img</span> <span class="o">-</span> <span class="n">minval</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">maxval</span> <span class="o">-</span> <span class="n">minval</span><span class="p">))</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span>

        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">img_obj</span><span class="p">,</span> <span class="n">mask</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing image and mask: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span></div>



<div class="viewcode-block" id="render_slice">
<a class="viewcode-back" href="../app.html#app.render_slice">[docs]</a>
<span class="k">def</span> <span class="nf">render_slice</span><span class="p">(</span>
    <span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">view</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Render a specific slice of the image and mask based on the view.</span>

<span class="sd">    Args:</span>
<span class="sd">        img (np.ndarray): Normalized image array.</span>
<span class="sd">        mask (np.ndarray): Mask array.</span>
<span class="sd">        x (int): Slice index.</span>
<span class="sd">        view (str): View type (&#39;axial&#39;, &#39;coronal&#39;, &#39;sagittal&#39;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[np.ndarray, np.ndarray]: </span>
<span class="sd">            - Slice of the image.</span>
<span class="sd">            - Slice of the mask.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">view</span> <span class="o">==</span> <span class="s2">&quot;axial&quot;</span><span class="p">:</span>
        <span class="n">slice_img</span><span class="p">,</span> <span class="n">slice_mask</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">mask</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="s2">&quot;coronal&quot;</span><span class="p">:</span>
        <span class="n">slice_img</span><span class="p">,</span> <span class="n">slice_mask</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:,</span> <span class="n">x</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mask</span><span class="p">[:,</span> <span class="n">x</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="s2">&quot;sagittal&quot;</span><span class="p">:</span>
        <span class="n">slice_img</span><span class="p">,</span> <span class="n">slice_mask</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">x</span><span class="p">],</span> <span class="n">mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">x</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid view type: </span><span class="si">{</span><span class="n">view</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Flip the slice images upside down for correct orientation</span>
    <span class="n">slice_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">slice_img</span><span class="p">)</span>
    <span class="n">slice_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">slice_mask</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">slice_img</span><span class="p">,</span> <span class="n">slice_mask</span></div>



<div class="viewcode-block" id="main_func">
<a class="viewcode-back" href="../app.html#app.main_func">[docs]</a>
<span class="k">def</span> <span class="nf">main_func</span><span class="p">(</span>
    <span class="n">image_t1c</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">image_t2f</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">image_t1n</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">image_t2w</span><span class="p">:</span> <span class="n">Path</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main function to handle segmentation workflow.</span>

<span class="sd">    This function orchestrates the entire segmentation process:</span>
<span class="sd">    1. Runs inference on the uploaded images.</span>
<span class="sd">    2. Processes the output to calculate volumetrics.</span>
<span class="sd">    3. Updates the global dictionary with relevant paths and data.</span>

<span class="sd">    Args:</span>
<span class="sd">        image_t1c (Path): Path to the T1 contrast-enhanced MRI image.</span>
<span class="sd">        image_t2f (Path): Path to the T2 FLAIR MRI image.</span>
<span class="sd">        image_t1n (Path): Path to the T1 pre-contrast MRI image.</span>
<span class="sd">        image_t2w (Path): Path to the T2 weighted MRI image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[str, str]: </span>
<span class="sd">            - Path to the segmentation mask file.</span>
<span class="sd">            - Status message with volumetrics.</span>

<span class="sd">    Raises:</span>
<span class="sd">        subprocess.CalledProcessError: If inference fails.</span>
<span class="sd">        Exception: If there is an error during processing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">image_t1c</span><span class="p">)</span>
    <span class="k">global</span> <span class="n">mydict</span>

    <span class="c1"># Run inference and get paths</span>
    <span class="n">input_path</span><span class="p">,</span> <span class="n">mask_path</span> <span class="o">=</span> <span class="n">run_inference</span><span class="p">(</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">image_t1c</span><span class="p">),</span> <span class="n">Path</span><span class="p">(</span><span class="n">image_t2f</span><span class="p">),</span> <span class="n">Path</span><span class="p">(</span><span class="n">image_t1n</span><span class="p">),</span> <span class="n">Path</span><span class="p">(</span><span class="n">image_t2w</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Retrieve all NIfTI files in the input directory</span>
    <span class="n">image_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="s2">&quot;*.nii.gz&quot;</span><span class="p">))</span>
    <span class="n">mydict</span><span class="p">[</span><span class="s2">&quot;img_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_files</span>
    <span class="n">mydict</span><span class="p">[</span><span class="s2">&quot;mask_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_path</span>

    <span class="c1"># Get image and mask data</span>
    <span class="n">img</span><span class="p">,</span> <span class="n">img_obj</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">get_img_mask</span><span class="p">(</span><span class="n">image_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mask_path</span><span class="p">)</span>

    <span class="c1"># Store image and mask as uint8 for display</span>
    <span class="n">mydict</span><span class="p">[</span><span class="s2">&quot;img&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">mydict</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">img_obj</span><span class="o">.</span><span class="n">GetSpacing</span><span class="p">())</span>
    <span class="n">spacing_tuple</span> <span class="o">=</span> <span class="n">img_obj</span><span class="o">.</span><span class="n">GetSpacing</span><span class="p">()</span>

    <span class="c1"># Calculate the multiplier for volume calculation</span>
    <span class="n">multiplier_ml</span> <span class="o">=</span> <span class="mf">0.001</span> <span class="o">*</span> <span class="n">spacing_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">spacing_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">spacing_tuple</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Calculate unique labels and their frequencies</span>
    <span class="n">unique</span><span class="p">,</span> <span class="n">frequency</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">total_sum</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Calculate volumetrics for each label</span>
    <span class="k">for</span> <span class="n">lbl</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">unique</span><span class="p">,</span> <span class="n">frequency</span><span class="p">):</span>
        <span class="n">ml_vol</span> <span class="o">=</span> <span class="n">multiplier_ml</span> <span class="o">*</span> <span class="n">count</span>
        <span class="n">mydict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;vol_lbl</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">lbl</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ml_vol</span>
        <span class="k">if</span> <span class="n">lbl</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">total_sum</span> <span class="o">+=</span> <span class="n">ml_vol</span>

    <span class="n">mydict</span><span class="p">[</span><span class="s2">&quot;vol_total&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_sum</span>

    <span class="c1"># Construct the status message</span>
    <span class="n">status_message</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Segmentation done! Total tumor volume segmented </span><span class="si">{</span><span class="n">mydict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vol_total&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> ml; &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;EDEMA(ED) </span><span class="si">{</span><span class="n">mydict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vol_lbl4&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> ml; &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;ENHANCING TUMOR(ET) </span><span class="si">{</span><span class="n">mydict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vol_lbl1&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> ml; &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;NON-ENHANCING TUMOR CORE(NETC) </span><span class="si">{</span><span class="n">mydict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vol_lbl2&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> ml; &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;CYSTIC COMPONENT(CC) </span><span class="si">{</span><span class="n">mydict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vol_lbl3&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> ml&quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">mask_path</span><span class="p">,</span> <span class="n">status_message</span></div>



<div class="viewcode-block" id="render">
<a class="viewcode-back" href="../app.html#app.render">[docs]</a>
<span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="n">file_to_render</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">view</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Render the specified slice of the image with annotations.</span>

<span class="sd">    Args:</span>
<span class="sd">        file_to_render (str): Type of scan to overlay the segmentation on.</span>
<span class="sd">        x (int): Slice index.</span>
<span class="sd">        view (str): View type (&#39;axial&#39;, &#39;coronal&#39;, &#39;sagittal&#39;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[PIL.Image.Image, List[Tuple[np.ndarray, str]]]: </span>
<span class="sd">            - Rendered image with segmentation overlay.</span>
<span class="sd">            - List of annotations for each label.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the specified file type is not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;T2 Flair&quot;</span><span class="p">:</span> <span class="s2">&quot;t2f&quot;</span><span class="p">,</span>
        <span class="s2">&quot;native T1&quot;</span><span class="p">:</span> <span class="s2">&quot;t1n&quot;</span><span class="p">,</span>
        <span class="s2">&quot;post-contrast T1-weighted&quot;</span><span class="p">:</span> <span class="s2">&quot;t1c&quot;</span><span class="p">,</span>
        <span class="s2">&quot;T2 weighted&quot;</span><span class="p">:</span> <span class="s2">&quot;t2w&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="s2">&quot;img_path&quot;</span> <span class="ow">in</span> <span class="n">mydict</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Find the corresponding file based on the selected scan type</span>
            <span class="n">get_file</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                <span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">mydict</span><span class="p">[</span><span class="s2">&quot;img_path&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">suffix</span><span class="p">[</span><span class="n">file_to_render</span><span class="p">]</span> <span class="ow">in</span> <span class="n">file</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No file found for scan type: </span><span class="si">{</span><span class="n">file_to_render</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No file found for scan type: </span><span class="si">{</span><span class="n">file_to_render</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Retrieve image and mask data</span>
        <span class="n">img</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">get_img_mask</span><span class="p">(</span><span class="n">get_file</span><span class="p">,</span> <span class="n">mydict</span><span class="p">[</span><span class="s2">&quot;mask_path&quot;</span><span class="p">])</span>

        <span class="c1"># Ensure the slice index is within valid range</span>
        <span class="n">max_index</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">view</span> <span class="o">==</span> <span class="s2">&quot;axial&quot;</span>
            <span class="k">else</span> <span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">view</span> <span class="o">==</span> <span class="s2">&quot;coronal&quot;</span> <span class="k">else</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">max_index</span><span class="p">))</span>

        <span class="c1"># Render the specific slice</span>
        <span class="n">slice_img</span><span class="p">,</span> <span class="n">slice_mask</span> <span class="o">=</span> <span class="n">render_slice</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">view</span><span class="p">)</span>

        <span class="c1"># Convert the slice to a PIL Image for display</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">slice_img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>

        <span class="c1"># Create annotations based on mask labels</span>
        <span class="n">annotations</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">slice_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ET: </span><span class="si">{</span><span class="n">mydict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vol_lbl1&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> ml&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">slice_mask</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;NETC: </span><span class="si">{</span><span class="n">mydict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vol_lbl2&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> ml&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">slice_mask</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;CC: </span><span class="si">{</span><span class="n">mydict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vol_lbl3&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> ml&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">slice_mask</span> <span class="o">==</span> <span class="mi">4</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ED: </span><span class="si">{</span><span class="n">mydict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vol_lbl4&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> ml&quot;</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">im</span><span class="p">,</span> <span class="n">annotations</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Return an empty image and no annotations if paths are not available</span>
        <span class="k">return</span> <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)),</span> <span class="p">[]</span></div>



<div class="viewcode-block" id="render_axial">
<a class="viewcode-back" href="../app.html#app.render_axial">[docs]</a>
<span class="k">def</span> <span class="nf">render_axial</span><span class="p">(</span><span class="n">file_to_render</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Render an axial slice of the image.</span>

<span class="sd">    Args:</span>
<span class="sd">        file_to_render (str): Type of scan to overlay the segmentation on.</span>
<span class="sd">        x (int): Slice index.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[PIL.Image.Image, List[Tuple[np.ndarray, str]]]: </span>
<span class="sd">            - Rendered axial image with segmentation.</span>
<span class="sd">            - Annotations for each label.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">file_to_render</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="s2">&quot;axial&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="render_coronal">
<a class="viewcode-back" href="../app.html#app.render_coronal">[docs]</a>
<span class="k">def</span> <span class="nf">render_coronal</span><span class="p">(</span><span class="n">file_to_render</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Render a coronal slice of the image.</span>

<span class="sd">    Args:</span>
<span class="sd">        file_to_render (str): Type of scan to overlay the segmentation on.</span>
<span class="sd">        x (int): Slice index.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[PIL.Image.Image, List[Tuple[np.ndarray, str]]]: </span>
<span class="sd">            - Rendered coronal image with segmentation.</span>
<span class="sd">            - Annotations for each label.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">file_to_render</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="s2">&quot;coronal&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="render_sagittal">
<a class="viewcode-back" href="../app.html#app.render_sagittal">[docs]</a>
<span class="k">def</span> <span class="nf">render_sagittal</span><span class="p">(</span><span class="n">file_to_render</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Render a sagittal slice of the image.</span>

<span class="sd">    Args:</span>
<span class="sd">        file_to_render (str): Type of scan to overlay the segmentation on.</span>
<span class="sd">        x (int): Slice index.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[PIL.Image.Image, List[Tuple[np.ndarray, str]]]: </span>
<span class="sd">            - Rendered sagittal image with segmentation.</span>
<span class="sd">            - Annotations for each label.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">file_to_render</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="s2">&quot;sagittal&quot;</span><span class="p">)</span></div>



<span class="c1"># Gradio UI Setup</span>
<span class="k">with</span> <span class="n">gr</span><span class="o">.</span><span class="n">Blocks</span><span class="p">()</span> <span class="k">as</span> <span class="n">demo</span><span class="p">:</span>
    <span class="c1"># Header</span>
    <span class="n">gr</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;&lt;center&gt;&lt;font size=&#39;6&#39;&gt;&lt;bold&gt; Children&#39;s National Pediatric Brain Tumor Segmenter&lt;/bold&gt;&lt;/font&gt;&lt;/center&gt;&quot;</span>
    <span class="p">)</span>
    <span class="n">gr</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;&lt;p style=&#39;margin-top: 1rem; margin-bottom: 1rem&#39;&gt; &lt;img src=&#39;</span><span class="si">{</span><span class="n">logo</span><span class="o">.</span><span class="n">logo</span><span class="si">}</span><span class="s2">&#39; alt=&#39;Childrens National Logo&#39; style=&#39;display: inline-block&#39;/&gt;&lt;/p&gt;&quot;</span>
    <span class="p">)</span>
    <span class="n">gr</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;&lt;justify&gt;&lt;font size=&#39;4&#39;&gt; Welcome to the pediatric brain tumor segmenter. Please read the &lt;a href=&#39;https://precision-medical-imaging-group.github.io/HOPE-Segmenter-Kids&#39;&gt;instructions&lt;/a&gt; before using the application. &lt;/font&gt;&lt;/justify&gt;&quot;</span>
    <span class="p">)</span>

    <span class="c1"># File Uploads</span>
    <span class="k">with</span> <span class="n">gr</span><span class="o">.</span><span class="n">Row</span><span class="p">():</span>
        <span class="n">image_t1c</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">File</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Upload T1 Contrast Enhanced Here:&quot;</span><span class="p">,</span>
            <span class="n">file_types</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;nii.gz&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">image_t2f</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">File</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Upload T2 FLAIR Here:&quot;</span><span class="p">,</span> <span class="n">file_types</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;nii.gz&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">image_t1n</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">File</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Upload T1 Pre-Contrast Here:&quot;</span><span class="p">,</span> <span class="n">file_types</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;nii.gz&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">image_t2w</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">File</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Upload T2 Weighted Here:&quot;</span><span class="p">,</span> <span class="n">file_types</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;nii.gz&quot;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="c1"># Segmentation Button</span>
    <span class="k">with</span> <span class="n">gr</span><span class="o">.</span><span class="n">Row</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">gr</span><span class="o">.</span><span class="n">Column</span><span class="p">():</span>
            <span class="n">gr</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Spacer</span>
        <span class="k">with</span> <span class="n">gr</span><span class="o">.</span><span class="n">Column</span><span class="p">():</span>
            <span class="n">btn</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="s2">&quot;Start Segmentation&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">gr</span><span class="o">.</span><span class="n">Column</span><span class="p">():</span>
            <span class="n">gr</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Spacer</span>

    <span class="c1"># Status Output</span>
    <span class="k">with</span> <span class="n">gr</span><span class="o">.</span><span class="n">Column</span><span class="p">():</span>
        <span class="n">out_text</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">Textbox</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Status&quot;</span><span class="p">,</span> <span class="n">placeholder</span><span class="o">=</span><span class="s2">&quot;Volumetrics will be updated here.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Dropdown for Rendering</span>
    <span class="k">with</span> <span class="n">gr</span><span class="o">.</span><span class="n">Row</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">gr</span><span class="o">.</span><span class="n">Column</span><span class="p">():</span>
            <span class="n">gr</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Spacer</span>
        <span class="k">with</span> <span class="n">gr</span><span class="o">.</span><span class="n">Column</span><span class="p">():</span>
            <span class="n">dropdown_modality</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;T2 Flair&quot;</span><span class="p">,</span><span class="s2">&quot;native T1&quot;</span><span class="p">,</span> <span class="s2">&quot;post-contrast T1-weighted&quot;</span><span class="p">,</span> <span class="s2">&quot;T2 weighted&quot;</span><span class="p">]</span>
            <span class="n">file_to_render</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
                <span class="n">dropdown_modality</span><span class="p">,</span>
                <span class="n">value</span> <span class="o">=</span>  <span class="n">dropdown_modality</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Choose the scan to overlay the segmentation on&#39;</span>
            <span class="p">)</span>
        <span class="k">with</span> <span class="n">gr</span><span class="o">.</span><span class="n">Column</span><span class="p">():</span>
            <span class="n">gr</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Spacer</span>

    <span class="c1"># Image Displays</span>
    <span class="k">with</span> <span class="n">gr</span><span class="o">.</span><span class="n">Row</span><span class="p">():</span>
        <span class="n">height</span> <span class="o">=</span> <span class="s2">&quot;20vw&quot;</span>
        <span class="n">myimage_axial</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">AnnotatedImage</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Axial View&quot;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">)</span>
        <span class="n">myimage_coronal</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">AnnotatedImage</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Coronal View&quot;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">)</span>
        <span class="n">myimage_sagittal</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">AnnotatedImage</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Sagittal View&quot;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">)</span>

    <span class="c1"># Sliders for Slice Selection</span>
    <span class="k">with</span> <span class="n">gr</span><span class="o">.</span><span class="n">Row</span><span class="p">():</span>
        <span class="n">slider_axial</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">Slider</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="mi">155</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Axial Slice&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;Adjust the axial slice.&quot;</span>
        <span class="p">)</span>  <span class="c1"># Max val needs to be updated by user.</span>
        <span class="n">state_axial</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">State</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">75</span><span class="p">)</span>
        <span class="n">slider_coronal</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">Slider</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="mi">155</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Coronal Slice&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;Adjust the coronal slice.&quot;</span>
        <span class="p">)</span>  <span class="c1"># Max val needs to be updated by user.</span>
        <span class="n">state_coronal</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">State</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">75</span><span class="p">)</span>
        <span class="n">slider_sagittal</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">Slider</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="mi">155</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Sagittal Slice&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;Adjust the sagittal slice.&quot;</span>
        <span class="p">)</span>  <span class="c1"># Max val needs to be updated by user.</span>
        <span class="n">state_sagittal</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">State</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">75</span><span class="p">)</span>

    <span class="c1"># Segmentation File Download</span>
    <span class="k">with</span> <span class="n">gr</span><span class="o">.</span><span class="n">Row</span><span class="p">():</span>
        <span class="n">mask_file</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Download Segmentation File&quot;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="s2">&quot;vw&quot;</span><span class="p">)</span>

    <span class="c1"># Examples Setup</span>
    <span class="n">example_dir</span> <span class="o">=</span> <span class="s2">&quot;/home/pmilab/Abhijeet/examples/&quot;</span>
    <span class="n">generate_examples</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">example_dir</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">))</span>
    <span class="n">order_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;-t1c.nii.gz&quot;</span><span class="p">,</span> <span class="s2">&quot;-t2f.nii.gz&quot;</span><span class="p">,</span> <span class="s2">&quot;-t1n.nii.gz&quot;</span><span class="p">,</span> <span class="s2">&quot;-t2w.nii.gz&quot;</span><span class="p">]</span>
    <span class="n">example_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="si">}{</span><span class="n">ending</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">ending</span> <span class="ow">in</span> <span class="n">order_list</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">generate_examples</span>
    <span class="p">]</span>

    <span class="n">gr</span><span class="o">.</span><span class="n">Examples</span><span class="p">(</span>
        <span class="n">examples</span><span class="o">=</span><span class="n">example_list</span><span class="p">,</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">image_t1c</span><span class="p">,</span> <span class="n">image_t2f</span><span class="p">,</span> <span class="n">image_t1n</span><span class="p">,</span> <span class="n">image_t2w</span><span class="p">],</span>
        <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">mask_file</span><span class="p">,</span> <span class="n">out_text</span><span class="p">],</span>
        <span class="n">fn</span><span class="o">=</span><span class="n">main_func</span><span class="p">,</span>
        <span class="n">cache_examples</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Preloaded BraTS2024 Examples&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Button Click Event</span>
    <span class="n">btn</span><span class="o">.</span><span class="n">click</span><span class="p">(</span>
        <span class="n">fn</span><span class="o">=</span><span class="n">main_func</span><span class="p">,</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">image_t1c</span><span class="p">,</span> <span class="n">image_t2f</span><span class="p">,</span> <span class="n">image_t1n</span><span class="p">,</span> <span class="n">image_t2w</span><span class="p">],</span>
        <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">mask_file</span><span class="p">,</span> <span class="n">out_text</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># Dropdown Selection Events</span>
    <span class="n">file_to_render</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
        <span class="n">render_axial</span><span class="p">,</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">file_to_render</span><span class="p">,</span> <span class="n">state_axial</span><span class="p">],</span>
        <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">myimage_axial</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">file_to_render</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
        <span class="n">render_coronal</span><span class="p">,</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">file_to_render</span><span class="p">,</span> <span class="n">state_coronal</span><span class="p">],</span>
        <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">myimage_coronal</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">file_to_render</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
        <span class="n">render_sagittal</span><span class="p">,</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">file_to_render</span><span class="p">,</span> <span class="n">state_sagittal</span><span class="p">],</span>
        <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">myimage_sagittal</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># Slider Change Events</span>
    <span class="n">slider_axial</span><span class="o">.</span><span class="n">change</span><span class="p">(</span>
        <span class="n">render_axial</span><span class="p">,</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">file_to_render</span><span class="p">,</span> <span class="n">slider_axial</span><span class="p">],</span>
        <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">myimage_axial</span><span class="p">],</span>
        <span class="n">api_name</span><span class="o">=</span><span class="s2">&quot;axial_slider&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">slider_coronal</span><span class="o">.</span><span class="n">change</span><span class="p">(</span>
        <span class="n">render_coronal</span><span class="p">,</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">file_to_render</span><span class="p">,</span> <span class="n">slider_coronal</span><span class="p">],</span>
        <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">myimage_coronal</span><span class="p">],</span>
        <span class="n">api_name</span><span class="o">=</span><span class="s2">&quot;coronal_slider&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">slider_sagittal</span><span class="o">.</span><span class="n">change</span><span class="p">(</span>
        <span class="n">render_sagittal</span><span class="p">,</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">file_to_render</span><span class="p">,</span> <span class="n">slider_sagittal</span><span class="p">],</span>
        <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">myimage_sagittal</span><span class="p">],</span>
        <span class="n">api_name</span><span class="o">=</span><span class="s2">&quot;sagittal_slider&quot;</span><span class="p">,</span>
    <span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">demo</span><span class="o">.</span><span class="n">queue</span><span class="p">()</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span><span class="n">server_name</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">server_port</span><span class="o">=</span><span class="mi">7860</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, PMI Lab.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>